#setup
library(tidyverse)
library(rvest)
library(nbastatR)
library(lubridate)
library(janitor)
library(heapsofpapers)
library(arrow)

#Open Parquets
gamedata <- read_parquet("data/raw/gamedata.parquet")
season_data <- read_parquet("data/raw/seasondata.parquet")
rosters <- read_parquet("data/raw/rosters.parquet")

#clean and combine play-by play data from 2022 season
pbp1 <- clean_names(read_parquet("data/raw/pbp2022_1.parquet"))
pbp2 <- clean_names(read_parquet("data/raw/pbp2022_2.parquet"))
pbp3 <- clean_names(read_parquet("data/raw/pbp2022_3.parquet"))

pbp <- rbind(pbp1, pbp2)
pbp <- rbind(pbp, pbp3)

#creating a 4th quarter db
pbp_4th <- pbp |>
    filter(number_period == 4)

write_parquet(x = pbp_4th, sink = "data/analysis/pbp_4thonly")
# Clean Rosters

id_bday <- rosters %>% 
    filter(!duplicated(id_player))
id_bday <- id_bday |>
    select(id_player, date_birth)
gamedata_plus <- inner_join(gamedata, id_bday, by = "id_player")

# Need to add a average ppg variable
gamedata_plus_ppg <- gamedata_plus %>% 
    group_by(year_season, id_player) %>%
    mutate( avg_ppg_szn = mean(pts, na.rm = TRUE)) %>%
    ungroup()

gamedata_plus_diff <- gamedata_plus_ppg %>%
    mutate(pts_diff = pts - avg_ppg_szn,
         is_bday = ifelse(month(date_game) == month(date_birth) & day(date_game) == day(date_birth), TRUE, FALSE))

# add minutes diff
gamedata_plus_diff <- gamedata_plus_diff %>% 
    group_by(year_season, id_player) %>%
    mutate( avg_min_szn = mean(minutes, na.rm = TRUE), min_diff = minutes - avg_min_szn) %>%
    ungroup
# save cleaned
write_parquet(gamedata_plus_diff, sink = "data/analysis/cleaned_gamedata.parquet")

unique_rosters <- rosters %>% 
    filter(!duplicated(id_player))
view(id_bday)