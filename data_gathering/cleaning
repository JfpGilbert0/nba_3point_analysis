#setup
library(tidyverse)
library(rvest)
library(nbastatR)
library(lubridate)
library(janitor)
library(heapsofpapers)
library(arrow)

#Open Parquets
gamedata <- read_parquet("data/raw/gamedata.parquet")
season_data <- read_parquet("data/raw/seasondata.parquet")
rosters <- read_parquet("data/raw/rosters.parquet")
# Clean Rosters

id_bday <- rosters %>% 
    filter(!duplicated(id_player))
id_bday <- id_bday |>
    select(id_player, date_birth)
gamedata_plus <- inner_join(gamedata, id_bday, by = "id_player")

# Need to add a average ppg variable
gamedata_plus_ppg <- gamedata_plus %>% 
    group_by(year_season, id_player) %>%
    mutate( avg_ppg_szn = mean(pts, na.rm = TRUE)) %>%
    ungroup()

gamedata_plus_diff <- gamedata_plus_ppg %>%
    mutate(pts_diff = pts - avg_ppg_szn,
         is_bday = ifelse(month(date_game) == month(date_birth) & day(date_game) == day(date_birth), TRUE, FALSE))

# save cleaned
write_parquet(gamedata_plus_diff, sink = "data/analysis/cleaned_gamedata.parquet")

unique_rosters <- rosters %>% 
    filter(!duplicated(id_player))
view(id_bday)