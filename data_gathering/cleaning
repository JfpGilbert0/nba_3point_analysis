#setup
library(tidyverse)
library(rvest)
library(nbastatR)
library(lubridate)
library(janitor)
library(heapsofpapers)
library(arrow)

#Open Parquets
game_data <- read_parquet("data/raw/gamedata_2022.parquet")
season_data <- read_parquet("data/raw/season_2022.parquet")
# Clean Rosters
rosters <- clean_names(seasons_rosters(seasons = 2022))
id_bday <- tibble(id_player = rosters$id_player, date_birth = rosters$date_birth)
gamedata_plus <- inner_join(gamedata, id_bday, by = "id_player")

# Need to add a average ppg variable
gamedata_plus_ppg <- gamedata_plus %>% 
    group_by(year_season, id_player) %>%
    mutate( avg_ppg_szn = mean(pts, na.rm = TRUE)) %>%
    ungroup()

damedata_plus_diff <- gamedata_plus_ppg %>%
    mutate(pts_diff = pts - avg_ppg_szn,
         is_bday = ifelse(month(date_game) == month(date_birth) & day(date_game) == day(date_birth), TRUE, FALSE))

# save cleaned
write_parquet(gamedata_plus_diff, sink = "data/analysis/cleaned_gamedata.parquet")

summary(gamedata_plus_ppg)